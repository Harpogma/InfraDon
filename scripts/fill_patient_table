CREATE TABLE IF NOT EXISTS temp_patient (
    Id INTEGER,
    Nom TEXT,
    Prenom TEXT,
    Date_de_naissance DATE,
    Adresse TEXT,
    Telephone TEXT
);

COPY temp_patient (Id, Nom, Prenom, Date_de_naissance, Adresse, Telephone)
FROM 'C:\Users\marc.bridy\InfraDon\InfraDon\data\csv\patient.csv'
WITH CSV HEADER;

CREATE TABLE IF NOT EXISTS temp_patient_update (
    Id INTEGER,
    Assurance TEXT,
    Sexe TEXT,
    Adresse TEXT
);

COPY temp_patient_update (Id, Assurance, Sexe, Adresse)
FROM 'C:\Users\marc.bridy\InfraDon\InfraDon\data\csv\patient_update.csv'
WITH CSV HEADER;

UPDATE patient
SET insurance_id = i.id
FROM temp_patient_update tp
INNER JOIN insurance i ON i.long_descr = split_part(tp.Assurance, ' +', 1)
INNER JOIN person p ON p.id = tp.Id 
WHERE patient.person_id = p.id;

INSERT INTO patient (date_of_birth, person_id)
SELECT Date_de_naissance, Id
FROM temp_patient
ON CONFLICT (id) DO NOTHING;

create table "insurance"(
id SERIAL primary key,
long_descr VARCHAR(40) not null,
supplementary BOOLEAN not null
);