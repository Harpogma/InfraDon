CREATE TEMP TABLE temp_person (
    Id INTEGER,
    Nom TEXT,
    Prenom TEXT,
    Date_de_naissance DATE,
    Adresse TEXT,
    Telephone TEXT
);

COPY temp_person (Id, Nom, Prenom, Date_de_naissance, Adresse, Telephone) 
FROM 'C:\Users\marc.bridy\InfraDon\InfraDon\data\csv\patient.csv' 
WITH CSV HEADER;

INSERT INTO person (id, last_name, first_name, address, phone_number)
SELECT Id, Nom, Prenom, Adresse, Telephone FROM temp_person
ON CONFLICT (Id) DO NOTHING;

CREATE TEMP TABLE temp_person_update (
    Id INTEGER,
    Assurance TEXT,
    Sexe TEXT,
    Adresse TEXT
);

COPY temp_person_update (Id, Assurance, Sexe, Adresse) 
FROM 'C:\Users\marc.bridy\InfraDon\InfraDon\data\csv\patient.csv' 
WITH CSV HEADER;

UPDATE person
SET gender_id = g.id
FROM temp_person_update tp
INNER JOIN gender g ON g.long_descr = tp.Sexe
WHERE person.id = tp.Id;